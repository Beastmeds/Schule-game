<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
(function scale(){
    const dpr = Math.min(window.devicePixelRatio||1, 2);
    canvas.width = W*dpr; canvas.height = H*dpr;
    canvas.style.width = W+'px'; canvas.style.height = H+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
})();

let keys = {}, score = 0, high = parseInt(localStorage.getItem('neon-high')||'0'), gameRunning = false;
document.getElementById('high').textContent = high;

const player = {x: W/2, y: H-110, w: 40, h: 40, vx: 0, speed: 7};
const obstacles = [], powerups = [], parts = [];
let obstacleTimer=0, obstacleInterval=70, level=1, levelTimer=0, invuln=0;
let boss=null, inBoss=false;

const diffMap={easy:0.8, normal:1, hard:1.4};
let difficulty='normal';
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let soundOn=true, masterVol=0.7;

function beep(freq,time=0.06){
    if(!soundOn) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq;
    g.gain.value=masterVol*0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+time);
}

function rand(a,b){ return Math.random()*(b-a)+a; }
function rectIntersect(x1,y1,w1,h1,x2,y2,w2,h2){ return x1<x2+w2 && x1+w1>x2 && y1<y2+h2 && y1+h1>y2; }
function rectCircleColl(rx,ry,rw,rh,cx,cy,cr){ const dx=Math.max(rx,Math.min(cx,rx+rw)); const dy=Math.max(ry,Math.min(cy,ry+rh)); return (dx-cx)**2+(dy-cy)**2<=cr**2; }
function drawRect(x,y,w,h,col,fill=false){ ctx.fillStyle=col; fill?ctx.fillRect(x,y,w,h):ctx.strokeRect(x,y,w,h); }
function drawCircle(x,y,r,col){ ctx.fillStyle=col; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function fillGlow(x,y,r,col){ const g = ctx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,col); g.addColorStop(1,'transparent'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

let touchX=null, touchHold=false, leftHold=false, rightHold=false;
canvas.addEventListener('touchstart', e=>{ touchX=e.touches[0].clientX; touchHold=true; });
canvas.addEventListener('touchmove', e=>{ e.preventDefault(); touchX=e.touches[0].clientX; });
canvas.addEventListener('touchend', e=>{ touchX=null; touchHold=false; });
document.getElementById('leftBtn').addEventListener('touchstart',()=>leftHold=true);
document.getElementById('leftBtn').addEventListener('touchend',()=>leftHold=false);
document.getElementById('rightBtn').addEventListener('touchstart',()=>rightHold=true);
document.getElementById('rightBtn').addEventListener('touchend',()=>rightHold=false);

// Overlay & Buttons
const startOverlay=document.getElementById('start');
const gameOverOverlay=document.getElementById('gameOver');
document.getElementById('btn-start').onclick=startGame;
document.getElementById('btn-restart').onclick=startGame;
document.getElementById('btn-home').onclick=()=>{gameOverOverlay.style.display='none'; startOverlay.style.display='flex';};
document.getElementById('btn-tutorial').onclick=()=>alert('Boss-Angriffe, PowerUps: Gelb=Unverwundbarkeit, GrÃ¼n=Slow, Blau=Score, Lila=Teleport, Cyan=Speed');
document.getElementById('themeSel').addEventListener('change', e=>{document.body.setAttribute('data-theme',e.target.value);});
document.getElementById('diffSel').addEventListener('change', e=>{difficulty=e.target.value;});
document.getElementById('soundToggle').addEventListener('change', e=>{soundOn=e.target.checked; if(soundOn) audioCtx.resume();});
document.getElementById('vol').addEventListener('input', e=>{masterVol=parseFloat(e.target.value);});

// Spiel starten
function startGame(){
    score=0; level=1; obstacleInterval=70; obstacleTimer=0; levelTimer=0; invuln=0;
    obstacles.length=0; powerups.length=0; parts.length=0; boss=null; inBoss=false;
    player.x=W/2; player.speed=7;
    gameRunning=true;
    startOverlay.style.display='none';
    gameOverOverlay.style.display='none';
    document.getElementById('score').textContent=score;
    document.getElementById('level').textContent=level;
    requestAnimationFrame(loop);
}

// Update & Draw
function update(){
    if(!gameRunning) return;
    // Player Bewegung
    let mv=0;
    if(leftHold||(keys['arrowleft']||keys['a'])) mv-=1;
    if(rightHold||(keys['arrowright']||keys['d'])) mv+=1;
    player.vx=mv*player.speed;
    player.x+=player.vx;
    if(touchX!=null){ const rect=canvas.getBoundingClientRect(); player.x+=(touchX-rect.left-player.x)*0.12; }
    player.x=Math.max(12,Math.min(W-12-player.w,player.x));

    // Hindernisse
    obstacleTimer++; 
    if(obstacleTimer>obstacleInterval){
        obstacleTimer=0; spawnObstacle();
        if(Math.random()<0.18) spawnPowerup();
        if(obstacleInterval>20) obstacleInterval*=0.993;
    }
    for(let i=obstacles.length-1;i>=0;i--){
        const o=obstacles[i]; o.y+=o.vy;
        if(o.y>H+80){ obstacles.splice(i,1); score++; document.getElementById('score').textContent=Math.floor(score);}
        if(invuln<=0 && rectIntersect(player.x,player.y,player.w,player.h,o.x,o.y,o.w,o.h) && !inBoss){ endGame(); beep(120); }
    }
    for(let i=powerups.length-1;i>=0;i--){
        const p=powerups[i]; p.y+=p.vy;
        if(rectCircleColl(player.x,player.y,player.w,player.h,p.x,p.y,p.r)){
            powerups.splice(i,1);
            switch(p.type){
                case 'inv': invuln=180; beep(800); break;
                case 'slow': obstacles.forEach(o=>o.vy*=0.6); setTimeout(()=>obstacles.forEach(o=>o.vy/=0.6),3000); beep(520); break;
                case 'score': score+=8; beep(1000); break;
                case 'tele': player.x=rand(20,W-60); beep(1100); break;
                case 'speed': player.speed+=2; setTimeout(()=>player.speed-=2,4000); beep(950); break;
            }
        } else if(p.y>H+40) powerups.splice(i,1);
    }

    // Partikel
    for(let i=parts.length-1;i>=0;i--){ parts[i].x+=parts[i].vx; parts[i].y+=parts[i].vy; parts[i].life--; if(parts[i].life<=0) parts.splice(i,1); }
    if(invuln>0) invuln--;

    // Level & Boss
    levelTimer++; if(levelTimer>1200){ levelTimer=0; level++; document.getElementById('level').textContent=level; obstacleInterval*=0.92; beep(600);}
    if(level>=5 && !inBoss) spawnBoss();
    if(inBoss && boss){
        boss.timer++; boss.x+=Math.sin(boss.timer*0.04)*2;
        if(boss.timer%40===0){const bx=rand(boss.x+20,boss.x+boss.w-20); obstacles.push({x:bx,y:boss.y+boss.h,w:12,h:12,vy:3+level*0.2});}
        if(invuln<=0 && rectIntersect(player.x,player.y,player.w,player.h,boss.x,boss.y,boss.w,boss.h)){ endGame(); beep(120);}
        boss.hp-=0; if(boss.hp<=0){ inBoss=false; boss=null; score+=60; level=1; document.getElementById('level').textContent=level; obstacleInterval=70; beep(1200); document.getElementById('lootMsg').textContent='Loot erhalten: Power-Up + Score Bonus!';}
    }
}

function loop(){
    if(gameRunning){
        update(); draw();
        requestAnimationFrame(loop);
    }
}

// Game Over
function endGame(){
    gameRunning=false;
    document.getElementById('finalScore').textContent='Score: '+Math.floor(score);
    if(Math.floor(score)>high){ high=Math.floor(score); localStorage.setItem('neon-high',high); document.getElementById('high').textContent=high; }
    gameOverOverlay.style.display='flex';
}

// Obstacle & PowerUp
function spawnObstacle(){ const w=rand(40,140); const x=rand(30,W-30-w); obstacles.push({x,y:-40,w,h:16+Math.random()*56,vy:rand(2.6,4)*diffMap[difficulty]+score/400}); }
function spawnPowerup(){ const types=['inv','slow','score','tele','speed']; const t=types[Math.floor(rand(0,types.length))]; powerups.push({x:rand(40,W-40),y:-30,r:12,vy:2.2,type:t}); }
function spawnBoss(){ boss={x:W/2-120,y:-220,w:240,h:140,vy:1.6,hp:30+level*8,pattern:0,timer:0}; inBoss=true; }

function draw(){
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<70;i++){const sx=(i*47+(score*0.7))%W;const sy=(i*83+(i*3))%H;ctx.fillStyle='rgba(255,255,255,'+(0.03+(i%5)*0.02)+')';ctx.fillRect(sx,sy,1,1);}
    for(const o of obstacles){ctx.fillStyle='rgba(255,77,224,0.95)'; ctx.fillRect(o.x,o.y,o.w,o.h);}
    for(const p of powerups){
        const col=p.type==='inv'?'#ffd166':p.type==='slow'?'#7ef1b8':p.type==='score'?'#8cc8ff':p.type==='tele'?'#c27fff':'#00fff6';
        drawCircle(p.x,p.y,p.r,col); fillGlow(p.x,p.y,26,col);
    }
    if(inBoss && boss){ drawRect(boss.x,boss.y,boss.w,boss.h,'#ff0044',true); ctx.fillStyle='#fff'; ctx.fillText('BOSS HP: '+boss.hp,boss.x+12,boss.y+18);}
    ctx.save(); if(invuln%10>4) ctx.globalAlpha=0.6; drawRect(player.x,player.y,player.w,player.h,'#00e5ff',true); ctx.restore();
    fillGlow(player.x+player.w/2,player.y+player.h/2,46,'rgba(0,229,255,0.12)');
    for(const p of parts){ ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();}
    ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle='var(--neon1)'; ctx.fillRect(0,H-58,W,58); ctx.restore();
}

// Tastatur
addEventListener('keydown', e=>{keys[e.key.toLowerCase()]=true;if(e.key===' '&&!gameRunning) startGame();});
addEventListener('keyup', e=>{keys[e.key.toLowerCase()]=false});
</script>
