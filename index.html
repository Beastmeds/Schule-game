<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Dodger — Boss & Loot Expanded</title>
  <style>
    :root{--bg:#0b0f1a;--bg-alt:#f5f7fb;--neon1:#00e5ff;--neon2:#ff4de0;--accent:#ffd166;--text:#dbe7ff}
    [data-theme="light"]{--bg:#f5f7fb;--bg-alt:#0b0f1a;--neon1:#006b7a;--neon2:#9a1671;--accent:#b86b00;--text:#0b1220}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;color:var(--text)}
    .wrap{display:grid;place-items:center;height:100%;padding:18px}
    canvas{display:block;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);background:linear-gradient(180deg,rgba(3,7,18,0.9),rgba(7,13,36,0.95))}
    .ui{position:fixed;left:18px;top:18px;font-size:14px}
    .hint{position:fixed;right:18px;top:18px;text-align:right;opacity:.95}
    button{background:transparent;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 12px;border-radius:8px;backdrop-filter:blur(4px);cursor:pointer}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));padding:20px;border-radius:12px;text-align:center;max-width:520px}
    h1{margin:0 0 8px;font-size:24px;color:var(--neon1);text-shadow:0 0 12px rgba(0,229,255,.12)}
    .small{font-size:13px;color:rgba(255,255,255,0.8)}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .footer{position:fixed;left:18px;bottom:18px;color:rgba(255,255,255,0.7);font-size:13px}
    .settings{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.22);padding:10px;border-radius:10px}
    label{display:flex;gap:8px;align-items:center}
    select,input[type=range]{margin-left:8px}
    .touchbar{position:fixed;left:0;right:0;bottom:0;height:70px;display:none;align-items:center;justify-content:center}
    .touchbtn{height:56px;width:120px;border-radius:12px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center}
    @media(max-width:720px){canvas{width:100%;height:60vh}.touchbar{display:flex}}
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <canvas id="game" width="1100" height="640" aria-label="Neon Dodger Spiel"></canvas>
  </div>

  <div class="ui">Score: <span id="score">0</span> • Level: <span id="level">1</span></div>
  <div class="hint">Highscore: <span id="high">0</span></div>
  <div class="footer">Neon Dodger — ← → / A D / Touch — Boss & Loot</div>

  <div id="start" class="overlay">
    <div class="panel">
      <h1>Neon Dodger — Ultimate</h1>
      <p class="small">Neu: Boss-Angriffsmuster, Loot, mehr Power-Ups, Teleport & Slow-Motion, Highscore speichern.</p>
      <div style="margin-top:12px" class="controls">
        <button id="btn-start">Spiel starten</button>
        <button id="btn-tutorial">Tutorial</button>
      </div>
      <div class="controls" style="margin-top:12px">
        <label>Theme<select id="themeSel"><option value="dark">Dunkel</option><option value="light">Hell</option></select></label>
        <label>Schwierigkeit<select id="diffSel"><option value="easy">Einfach</option><option value="normal" selected>Normal</option><option value="hard">Schwer</option></select></label>
      </div>
    </div>
  </div>

  <div id="gameOver" class="overlay" style="display:none">
    <div class="panel">
      <h1 id="goTitle" style="color:var(--neon2)">Game Over</h1>
      <p id="finalScore"></p>
      <p id="lootMsg"></p>
      <div style="margin-top:12px" class="controls">
        <button id="btn-restart">Nochmal</button>
        <button id="btn-home">Zurück</button>
      </div>
    </div>
  </div>

  <div class="settings">
    <label>Musik <input id="soundToggle" type="checkbox" checked></label>
    <label>Volume <input id="vol" type="range" min="0" max="1" step="0.05" value="0.7"></label>
    <label>FPS <select id="fpsSel"><option>60</option><option>30</option></select></label>
  </div>

  <div class="touchbar" id="touchbar">
    <div class="touchbtn" id="leftBtn">◀</div>
    <div style="width:16px"></div>
    <div class="touchbtn" id="rightBtn">▶</div>
  </div>

  <script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W = canvas.width, H = canvas.height;
  (function scale(){ const dpr = Math.min(window.devicePixelRatio||1, 2); canvas.width = W*dpr; canvas.height = H*dpr; canvas.style.width = W+'px'; canvas.style.height = H+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); })();

  let keys={}, score=0, high=parseInt(localStorage.getItem('neon-high')||'0'), gameRunning=false;
  document.getElementById('high').textContent=high;
  const player={x:W/2,y:H-110,w:40,h:40,vx:0,speed:7};
  const obstacles=[], powerups=[], parts=[];
  let obstacleTimer=0, obstacleInterval=70, level=1, levelTimer=0, invuln=0;
  let boss=null, inBoss=false;
  const diffMap={easy:0.8, normal:1, hard:1.4}; let difficulty='normal';
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)(); let soundOn=true, masterVol=0.7;
  function beep(freq,time=0.06){ if(!soundOn) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=masterVol*0.06; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+time); }
  function rand(a,b){return Math.random()*(b-a)+a}

  addEventListener('keydown', e=>{keys[e.key.toLowerCase()]=true;if(e.key===' '&&!gameRunning) startGame();});
  addEventListener('keyup', e=>{keys[e.key.toLowerCase()]=false});

  let touchX=null, touchHold=null, leftHold=false, rightHold=false;
  canvas.addEventListener('touchstart', e=>{touchX=e.touches[0].clientX; touchHold=true;});
  canvas.addEventListener('touchmove', e=>{e.preventDefault(); touchX=e.touches[0].clientX;});
  canvas.addEventListener('touchend', e=>{touchX=null; touchHold=false;});
  document.getElementById('leftBtn').addEventListener('touchstart',()=>leftHold=true); document.getElementById('leftBtn').addEventListener('touchend',()=>leftHold=false);
  document.getElementById('rightBtn').addEventListener('touchstart',()=>rightHold=true); document.getElementById('rightBtn').addEventListener('touchend',()=>rightHold=false);

  const startOverlay=document.getElementById('start'); const gameOverOverlay=document.getElementById('gameOver');
  document.getElementById('btn-start').onclick=startGame;
  document.getElementById('btn-restart').onclick=startGame;
  document.getElementById('btn-home').onclick=()=>{gameOverOverlay.style.display='none'; startOverlay.style.display='flex';}
  document.getElementById('btn-tutorial').onclick=()=>alert('Boss-Angriffe, PowerUps: Gelb=Unverwundbarkeit, Grün=Slow, Blau=Score, Lila=Teleport, Cyan=Speed');
  document.getElementById('themeSel').addEventListener('change', e=>{document.body.setAttribute('data-theme',e.target.value);});
  document.getElementById('diffSel').addEventListener('change', e=>{difficulty=e.target.value;});
  document.getElementById('soundToggle').addEventListener('change', e=>{soundOn=e.target.checked; if(soundOn) audioCtx.resume();});
  document.getElementById('vol').addEventListener('input', e=>{masterVol=parseFloat(e.target.value);});

  function spawnObstacle(){ const w=rand(40,140); const x=rand(30,W-30-w); obstacles.push({x,y:-40,w,h:16+Math.random()*56,vy:rand(2.6,4)*diffMap[difficulty]+score/400});}
  function spawnPowerup(){ const types=['inv','slow','score','tele','speed']; const t=types[Math.floor(rand(0,types.length))]; powerups.push({x:rand(40,W-40),y:-30,r:12,vy:2.2,type:t});}

  function spawnBoss(){ boss={x:W/2-120,y:-220,w:240,h:140,vy:1.6,hp:30+level*8,pattern:0,timer:0}; inBoss=true;}

  function update(){
    if(leftHold) player.x-=player.speed; else if(rightHold) player.x+=player.speed;
    if(touchX!=null){ const rect=canvas.getBoundingClientRect(); player.x+=(touchX-rect.left-player.x)*0.12; }
    else { let mv=0;if(keys['arrowleft']||keys['a']) mv-=1;if(keys['arrowright']||keys['d']) mv+=1; player.vx=mv*player.speed; player.x+=player.vx; }
    player.x=Math.max(12,Math.min(W-12-player.w,player.x));

    obstacleTimer++; if(obstacleTimer>obstacleInterval){obstacleTimer=0; spawnObstacle(); if(Math.random()<0.18) spawnPowerup(); if(obstacleInterval>20) obstacleInterval*=0.993;}

    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.y+=o.vy; if(o.y>H+80){obstacles.splice(i,1); score+=1; document.getElementById('score').textContent=Math.floor(score);} if(invuln<=0 && rectIntersect(player.x,player.y,player.w,player.h,o.x,o.y,o.w,o.h) && !inBoss){for(let k=0;k<18;k++) parts.push({x:player.x+player.w/2,y:player.y+player.h/2,vx:rand(-4,4),vy:rand(-6,2),life:rand(30,70),r:rand(1,3),c:'#fff'}); beep(120); endGame(); }}

    for(let i=powerups.length-1;i>=0;i--){ const p=powerups[i]; p.y+=p.vy; if(rectCircleColl(player.x,player.y,player.w,player.h,p.x,p.y,p.r)){ powerups.splice(i,1); if(p.type==='inv'){invuln=180; beep(800);} else if(p.type==='slow'){obstacles.forEach(o=>o.vy*=0.6); setTimeout(()=>{obstacles.forEach(o=>o.vy/=0.6)},3000); beep(520);} else if(p.type==='score'){score+=8; beep(1000);} else if(p.type==='tele'){player.x=rand(20,W-60); beep(1100);} else if(p.type==='speed'){player.speed+=2; setTimeout(()=>{player.speed-=2},4000); beep(950);} } else if(p.y>H+40) powerups.splice(i,1); }

    for(let i=parts.length-1;i>=0;i--){ parts[i].x+=parts[i].vx; parts[i].y+=parts[i].vy; parts[i].life--; if(parts[i].life<=0) parts.splice(i,1); }
    if(invuln>0) invuln--;

    levelTimer++; if(levelTimer>1200){levelTimer=0; level++; document.getElementById('level').textContent=level; obstacleInterval*=0.92; beep(600);}
    if(level>=5 && !inBoss) spawnBoss();

    if(inBoss && boss){ boss.timer++; boss.x+=Math.sin(boss.timer*0.04)*2; if(boss.timer%40===0){const bx=rand(boss.x+20,boss.x+boss.w-20); obstacles.push({x:bx,y:boss.y+boss.h,w:12,h:12,vy:3+level*0.2});} if(invuln<=0 && rectIntersect(player.x,player.y,player.w,player.h,boss.x,boss.y,boss.w,boss.h)){for(let k=0;k<30;k++) parts.push({x:player.x+player.w/2,y:player.y+player.h/2,vx:rand(-4,4),vy:rand(-6,2),life:rand(30,70),r:rand(1,3),c:'#fff'}); beep(120); endGame();} boss.hp-=0; if(boss.hp<=0){inBoss=false; boss=null; score+=60; level=1; document.getElementById('level').textContent=level; obstacleInterval=70; beep(1200); document.getElementById('lootMsg').textContent='Loot erhalten: Power-Up + Score Bonus!';}
  }}

  function endGame(){ gameRunning=false; document.getElementById('finalScore').textContent='Score: '+Math.floor(score); if(Math.floor(score)>high){ high=Math.floor(score); localStorage.setItem('neon-high',high); document.getElementById('high').textContent=high; } gameOverOverlay.style.display='flex'; }

  function draw(){ ctx.clearRect(0,0,W,H); for(let i=0;i<70;i++){const sx=(i*47+(score*0.7))%W;const sy=(i*83+(i*3))%H;ctx.fillStyle='rgba(255,255,255,'+(0.03+(i%5)*0.02)+')';ctx.fillRect(sx,sy,1,1);} for(const o of obstacles){ctx.fillStyle='rgba(255,77,224,0.95)'; ctx.fillRect(o.x,o.y,o.w,o.h);} for(const p of powerups){const col=p.type==='inv'?'#ffd166':p.type==='slow'?'#7ef1b8':p.type==='score'?'#8cc8ff':p.type==='tele'?'#c27fff':'#00fff6'; drawCircle(p.x,p.y,p.r,col); fillGlow(p.x,p.y,26,col);} if(inBoss && boss){drawRect(boss.x,boss.y,boss.w,boss.h,'#ff0044',true); ctx.fillStyle='#fff'; ctx.fillText('BOSS HP: '+boss.hp,boss.x+12,boss.y+18);} ctx.save(); if(invuln%10>4) ctx.globalAlpha=0.6; drawRect(player.x,player.y,player.w,player.h,'#00e5ff',true); ctx.restore(); fillGlow(player.x+player.w/2,player.y+player.h/2,46,'rgba(0,229,255,0.12)'); for(const p of parts){ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();} ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle='var(--neon1)'; ctx.fillRect(0,H-58,W,58); ctx.restore();}

